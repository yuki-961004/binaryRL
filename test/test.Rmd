---
title: "Untitled"
author: "yuki"
date: "2025-03-19"
output: html_document
---
```{r}
install.packages("../../binaryRL_0.5.12.tar.gz")
```

```{r}
library(binaryRL)
```

```{r}
head(Ludvig_2014_Exp1)
```

```{r}
Ludvig_2014_Exp1 %>%
  dplyr::select(L_choice, L_reward) %>%
  dplyr::group_by(L_choice) %>%
  dplyr::mutate(mean_value = mean(L_reward)) %>%
  dplyr::ungroup() %>%
  dplyr::select(L_choice, mean_value) %>%
  dplyr::distinct()
```

```{r}
model <- function(params){
  # get variables from fit_env which will be generated by fit_p()
  data <- get(x = "fit_data", envir = fit_env)
  id <- get(x = "fit_id", envir = fit_env)
  n_params <- get(x = "fit_n_params", envir = fit_env)
  n_trials <- get(x = "fit_n_trials", envir = fit_env)

  # build a RL model
  res <- binaryRL::run_m(
    data = data,                    # your data
    id = id,                        # Subject ID
    eta = c(params[1], params[2]),  # free parameters (RSTD)
    n_params = n_params,            # the number of free parameters
    n_trials = n_trials             # the number of total trials
  )

  # pass the result to the fit_env
  assign(x = "binaryRL_res", value = res, envir = fit_env)
  
  # return -logL for algorithm packages to optim free parameters
  return(-res$ll) 
}
```

```{r message=FALSE, warning=FALSE}
binaryRL_res <- binaryRL::fit_p(
  data = Ludvig_2014_Exp1,
  id = 1,
  n_params = 3,
  n_trials = 288,
  obj_func = binaryRL::RSTD.fit,
  lower = c(0, 0, 0),
  upper = c(1, 1, 1),
  iteration = 10,
  seed = 123,
  algorithm = "PSO"       # Particle Swarm Optimization (pso::psoptim)
  #algorithm = "DEoptim"   # Differential Evolution (DEoptim::DEoptim)
  #algorithm = "Bayesian"  # Bayesian Optimization (mlrMBO::mbo)
  #algorithm = "L-BFGS-B"  # Gradient-Based (stats::optim)
  #algorithm = "GenSA"     # Simulated Annealing (GenSA::GenSA)
  #algorithm = "CMA-ES"    # Covariance Matrix Adapting (`cmaes::cma_es`)
  #algorithm = "GA"        # Genetic Algorithm (GA::ga)
)
```


```{r}
list_simulated <- binaryRL::simulate_list(
  data = Ludvig_2014_Exp1,
  simulate_model = binaryRL::RSTD.simulate,
  n_params = 3, 
  n_trials = 288,
  lower = c(0, 0, 1),
  upper = c(1, 1, 1),
  seed = 123,
  iteration = 10
)
```

```{r include=FALSE}
df_recovery <- binaryRL::recovery_data(
  list = list_simulated,
  id = 1,
  fit_model = binaryRL::RSTD.fit,
  model_name = "RSTD",
  n_params = 3,
  n_trials = 288,
  lower = c(0, 0, 1),
  upper = c(1, 1, 1),
  iteration = 10,
  algorithm = "PSO"
)
```

```{r}
cor(df_recovery$input_param_1, df_recovery$output_param_1)
cor(df_recovery$input_param_2, df_recovery$output_param_2)

cor(df_recovery$input_param_1, df_recovery$input_param_2)
cor(df_recovery$output_param_1, df_recovery$output_param_2)
```

```{r}
binaryRL::rcv_d(
  data = Ludvig_2014_Exp1,
  n_params = c(2, 3, 3),
  n_trials = 288,
  simulate_models = list(TD.simulate),
  fit_models = list(TD.fit, RSTD.fit, Utility.fit),
  model_names = c("TD", "RSTD", "Utility"),
  recovery = c("parameter", "model"),
  initial_params = NA,
  initial_size = 50,
  iteration_s = 3,
  iteration_f = 10,
  seed = 123,
  algorithm = "PSO"
)
```


```{r}
fake_parameter_recovery <- function(){
  # 设置随机种子，确保结果可重复
  set.seed(123)
  
  # 生成 simulated_eta，均匀分布在 0 到 1 之间
  simulated_eta <- runif(100, 0, 1)
  
  # 生成 fit_eta，基于 simulated_eta 增加一些随机噪声
  fit_eta <- simulated_eta + rnorm(100, 0, 0.1)
  
  # 将 fit_eta 限制在 0 到 1 之间
  fit_eta[fit_eta < 0] <- 0
  fit_eta[fit_eta > 1] <- 1
  
  # 创建数据框
  data <- data.frame(simulated_eta, fit_eta)
  
  return(data)
}

data <- fake_parameter_recovery()

ggplot2::ggplot(data = data, aes(x = simulated_eta, y = fit_eta)) +
  ggplot2::geom_point(color = "#053562") +  # 绘制散点
  ggplot2::geom_abline(intercept = 0, slope = 1, color = "#55c186") +  # 添加 y = x 的直线
  ggplot2::labs(x = "simulated η", y = "fit η") +  # 添加坐标轴标签
  papaja::theme_apa() +
  ggplot2::theme(
    text = element_text(
      family = "serif", 
      face = "bold",
      size = 15
    ),
    axis.text = element_text(
      color = "black",
      family = "serif", 
      face = "bold",
      size = 10
    )
  )


ggplot2::ggsave(filename = "./ignore/param_recovery.png", height = 3, width = 4)
```

```{r}
fake_model_comparison <- function(n_params, n_trials = 288, seed = 123) {
  set.seed(seed)

  # 设置模型数量
  num_models <- 2

  # 生成模型名称
  models <- paste("Model", 1:num_models)

  # 生成准确率（ACC）
  ACC <- round(runif(num_models, 70, 100), 2)

  # 生成对数似然值（LogL）
  LogL <- round(runif(num_models, -120, -80), 2)

  # 设置参数数量
  n_params <- n_params # 模型1的参数为2，模型2的参数为4

  # 计算 AIC 和 BIC
  AIC <- 2 * n_params - 2 * LogL
  BIC <- n_params * log(n_trials) - 2 * LogL

  # 创建数据框
  data <- data.frame(model = models, ACC = ACC, LogL = -LogL, AIC = AIC, BIC = BIC)

  return(data)
}

# 调用函数生成数据
data <- fake_model_comparison(n_params = c(2, 4), n_trials = 288) %>%
  tidyr::pivot_longer(
    cols = c(ACC, LogL, AIC, BIC), 
    names_to = "metric", 
    values_to = "value"
  ) %>%
  dplyr::mutate(
    metric = factor(
      metric, 
      levels = c('ACC', 'LogL', 'AIC', 'BIC'),
      labels = c('ACC', '-LogL', 'AIC', 'BIC')
    )
  )

# 绘制条形图
ggplot2::ggplot(data, aes(x = metric, y = value, fill = model)) +
  ggplot2::geom_bar(stat = "identity", position = "dodge") +
  ggplot2::labs(x = "", y = "", fill = "Model") +
  papaja::theme_apa() +
  ggplot2::scale_fill_manual(
    values = c("#053562", "#55c186")
  ) +
  ggplot2::theme(
    legend.title = element_blank(),
    text = element_text(
      family = "serif", 
      face = "bold",
      size = 25
    ),
    axis.text = element_text(
      color = "black",
      family = "serif", 
      face = "bold",
      size = 20
    )
  )

ggplot2::ggsave(filename = "./ignore/model_comparison.png", height = 6, width = 8)
```

```{r}

```

