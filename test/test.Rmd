---
title: "Untitled"
author: "yuki"
date: "2025-03-19"
output: html_document
---
```{r}
install.packages("../../binaryRL_0.5.0.tar.gz")
```

```{r}
library(binaryRL)
data <- TAFC
data <- read.csv("./df_pilot.csv")
```

```{r}
model <- function(params){
  # since `obj_func`(model) can only be one argument, `params`, 
  # the data must be retrieved from the parent environment.
  data <- get("data", envir = parent.frame()) 

  # build a RL model
  res <- binaryRL::run_m(
    data = data,                    # your data
    id = 18,                        # Subject ID
    eta = c(params[1], params[2]),  # free parameters (RSTD)
    n_params = 2,                   # the number of free parameters
    n_trials = 288                  # the number of total trials
  )

  # pass the result to the parent environment
  # make it easier to get the optimal parameters later
  assign("binaryRL_res", res, envir = parent.frame())
  
  # if the algorithm is solving a minimization problem, return -ll
  invisible(-res$ll) # L-BFGS-B, GenSA, DEoptim Bayesian ...
  # if the algorithm is solving a maximization problem, return ll
  # invisible(res$ll) # GA ...
}
```

```{r}
n_params <- length(lower) # 假设 lower 是一个包含参数下界的向量

# 动态生成参数列表
param_list <- lapply(1:n_params, function(i) {
  ParamHelpers::makeNumericParam(
    id = paste0("param_", i),  # 生成参数 id，如 "param_1", "param_2" 等
    lower = lower[i],          # 从 lower 向量中获取下界
    upper = upper[i]           # 从 upper 向量中获取上界 
  )
})

# 创建一个mlrMBO接受的函数
bys_func <- smoof::makeSingleObjectiveFunction(
  name = "RL",
  fn = model,
  par.set = ParamHelpers::makeParamSet(params = param_list) 
)

result = mlrMBO::mbo(
  fun = bys_func, 
  design = ParamHelpers::generateDesign(
    n = 50L, 
    ParamHelpers::getParamSet(bys_func), 
    fun = lhs::maximinLHS
  ), 
  control = mlrMBO::setMBOControlTermination(
    mlrMBO::makeMBOControl(), 
    iters = 10L
  )
)

result$final.opt.state$opt.result$mbo.result$x

model(params = as.vector(as.numeric(res$final.opt.state$opt.result$mbo.result$x)))
```

```{r}
binaryRL_res <- binaryRL::fit_p(
  data = data,
  obj_func = model,
  initial = 50,
  lower = c(0, 0),
  upper = c(1, 1),
  iteration = 10,
  seed = 123,
  algorithm = "Bayesian"  # Bayesian Optimization (mlrMBO)
  #algorithm = "DEoptim"   # Differential Evolution (DEoptim)
  #algorithm = "GA"        # Genetic Algorithm (GA::ga)
  #algorithm = "GenSA"     # Simulated Annealing (GenSA::GenSA)
  #algorithm = "L-BFGS-B"  # Gradient-Based (stats::optim)
)
```

```{r}
RSTD <- function(params){
  data <- get("data", envir = parent.frame()) 
  
  res <- binaryRL::run_m(
    back = TRUE,                    # simulate raw data
    data = data,                    # your data
    id = 18,                        # Subject ID
    eta = c(params[1], params[2]),  # free parameters (RSTD)
    tau = c(params[3]),
    n_params = 2,                   # the number of free parameters
    n_trials = 288                  # the number of total trials
  )

  return(res)
}

list_simulated <- binaryRL::simulate_l(
  data = data,
  obj_func = RSTD,
  n_params = 3, 
  lower = c(0, 0, 0),
  upper = c(1, 1, 0.5),
  seed = 123,
  iteration = 3
)
```

```{r}
RSTD <- function(params){
  data <- get("data", envir = parent.frame()) 
  
  res <- binaryRL::run_m(
    data = data,                    # your data
    id = 18,                        # Subject ID
    eta = c(params[1], params[2]),  # free parameters (RSTD)
    tau = c(params[3]),
    n_params = 3,                   # the number of free parameters
    n_trials = 288                  # the number of total trials
  )

  assign("binaryRL_res", res, envir = parent.frame())
  
  invisible(-res$ll)
}

df_recovery <- binaryRL::recovery_d(
  list = list_simulated,
  obj_func = RSTD,
  model_name = "RSTD",
  lower = c(0, 0, 0),
  upper = c(1, 1, 0.5),
  seed = 123,
  iteration = 3,
  algorithm = "DEoptim"
)
```

