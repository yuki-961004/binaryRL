Ludvig, E. A., Madan, C. R., & Spetch, M. L. (2014). Extreme outcomes sway risky decisions from experience. Journal of Behavioral Decision Making, 27(2), 146-156. https://doi.org/10.1002/bdm.1792

https://osf.io/eagcd/

# 2014_JBDM
## [5] Exp 1
```{r}
step1 <- read.csv(
  file = "./ignore/2014_JBDM_Exp_1.csv"
) %>%
  dplyr::select(
    Subject, Block, Trial, 
    RT = Click.RT, 
    StimType, 
    TrialType,
    Choose = Click.Stim, 
    L,
    R,
    Reward = RewardAmount, 
    NetWorth = CumulativeReward, 
  ) %>%
  dplyr::filter(RT != "NULL") %>% # exclude NULL rows
  tidyr::separate(
    StimType, 
    into = c("DL", "DR"), 
    sep = "0", 
    remove = FALSE, 
    extra = "drop"
  ) %>%
  dplyr::mutate(
    Subject = Subject - 100,
    Block = (Block + 1) / 2,
    Frame = case_when(
      DL %in% c(1, 2) & DR %in% c(1, 2) ~ "Gain",
      DL %in% c(4, 5) & DR %in% c(4, 5) ~ "Loss",
      DL %in% c(1, 2) & DR %in% c(4, 5) ~ "Catch",
      DL %in% c(4, 5) & DR %in% c(1, 2) ~ "Catch",
      TRUE ~ "Single"
    ),
    L_choice = DL,
    R_choice = case_when(
      Frame == "Single" ~ DL,
      TRUE ~ DR,
    ),
    L = case_when(
      L == "Win0" ~ 0,
      L == "Win20" ~ 20,
      L == "Win40" ~ 40,
      L == "Lose0" ~ 0,
      L == "Lose20" ~ -20,
      L == "Lose40" ~ -40,
      L == "Grey" ~ NA
    ),
    R = case_when(
      R == "Win0" ~ 0,
      R == "Win20" ~ 20,
      R == "Win40" ~ 40,
      R == "Lose0" ~ 0,
      R == "Lose20" ~ -20,
      R == "Lose40" ~ -40,
      R == "Grey" ~ NA
    ),
  
    L_reward = case_when(
      Frame == "Single" ~ Reward,
      is.na(L) & L_choice == 1 ~ 20,
      is.na(L) & L_choice == 2 ~ NA,
      is.na(L) & L_choice == 4 ~ -20,
      is.na(L) & L_choice == 5 ~ NA,
      TRUE ~ L
    ),
    R_reward = case_when(
      Frame == "Single" ~ Reward,
      is.na(R) & R_choice == 1 ~ 20,
      is.na(R) & R_choice == 2 ~ NA,
      is.na(R) & R_choice == 4 ~ -20,
      is.na(R) & R_choice == 5 ~ NA,
      TRUE ~ R
    ),
    Sub_Choose = case_when(
      Choose == "Door1" ~ 1,
      Choose == "Door2" ~ 2,
      Choose == "Door4" ~ 4,
      Choose == "Door5" ~ 5,
    )
  ) %>%
  dplyr::arrange(Subject, Block, Trial) %>%
  dplyr::mutate_at(
    vars(Subject, Block, Trial, L_choice, R_choice, Sub_Choose, Frame),
    factor
  ) %>%
  dplyr::mutate_at(
    vars(L_reward, R_reward, NetWorth, RT),
    as.numeric
  ) %>%
  dplyr::select(
    Subject, Block, Trial,
    L_choice, R_choice, 
    L_reward, R_reward,
    Sub_Choose, 
    Frame, NetWorth, RT
  ) 
```

```{r}
step2 <- step1 %>%
  dplyr::mutate(
    L_choice = case_when(
      L_choice == 1 ~ 'A',
      L_choice == 2 ~ 'B',
      L_choice == 4 ~ 'C',
      L_choice == 5 ~ 'D',
    ), 
    R_choice = case_when(
      R_choice == 1 ~ 'A',
      R_choice == 2 ~ 'B',
      R_choice == 4 ~ 'C',
      R_choice == 5 ~ 'D',
    ),  
    Sub_Choose = case_when(
      Sub_Choose == 1 ~ 'A',
      Sub_Choose == 2 ~ 'B',
      Sub_Choose == 4 ~ 'C',
      Sub_Choose == 5 ~ 'D',
    ),
    L_choice = factor(
      L_choice, levels = c('A', 'B', 'C', 'D')
    ),
    R_choice = factor(
      R_choice, levels = c('A', 'B', 'C', 'D')
    ),
    Sub_Choose = factor(
      Sub_Choose, levels = c('A', 'B', 'C', 'D')
    ),
  ) 
  
# 生成临时的列, 方便存取当前价值
step3 <- step2 %>%
  dplyr::mutate(
    A = case_when(
      L_choice == 'A' ~ L_reward,
      R_choice == 'A' ~ R_reward,
      TRUE ~ 999
    ),
    B = case_when(
      L_choice == 'B' ~ L_reward,
      R_choice == 'B' ~ R_reward,
      TRUE ~ 999
    ),
    C = case_when(
      L_choice == 'C' ~ L_reward,
      R_choice == 'C' ~ R_reward,
      TRUE ~ 999
    ),
    D = case_when(
      L_choice == 'D' ~ L_reward,
      R_choice == 'D' ~ R_reward,
      TRUE ~ 999
    ),
  )
```


```{r message=FALSE, warning=FALSE}
fill_na_rewards_auto <- function(df, column) {
  num_0 <- sum(df[[column]] == 0, na.rm = TRUE)
  num_40 <- sum(df[[column]] == 40 | df[[column]] == -40, na.rm = TRUE)
  num_999 <- sum(df[[column]] == 999, na.rm = TRUE)
  num_na <- sum(is.na(df[[column]]))
  
  total_count <- num_0 + num_40 + num_na
  target_0 <- round(total_count / 2)  # 目标 0 数量
  target_40 <- total_count - target_0  # 目标 40 数量
  
  fill_0 <- target_0 - num_0
  fill_40 <- target_40 - num_40
  
  na_indices <- which(is.na(df[[column]]))
  
  set.seed(123)  
  zero_indices <- sample(na_indices, fill_0)
  forty_indices <- setdiff(na_indices, zero_indices)
  
  
  if (column == "B") {
    df[[column]][zero_indices] <- 0
    df[[column]][forty_indices] <- 40 
  } else if (column == "D") {
    df[[column]][zero_indices] <- 0
    df[[column]][forty_indices] <- -40 
  }

  return(df)
}
```

```{r}
#################################Save Data######################################
  
subj_list <- list()

for (i in 1:40) {
  df <- step3 %>% dplyr::filter(Subject == i) 
  df_B <- fill_na_rewards_auto(df = df, column = "B")
  df_D <- fill_na_rewards_auto(df = df_B, column = "D")

  df_fill <- df_D %>%
    dplyr::mutate(
      L_reward = case_when(
        L_choice == "B" & is.na(L_reward) ~ B,
        L_choice == "D" & is.na(L_reward) ~ D,
        TRUE ~ L_reward
      ),
      R_reward = case_when(
        R_choice == "B" & is.na(R_reward) ~ B,
        R_choice == "D" & is.na(R_reward) ~ D,
        TRUE ~ R_reward
      ),
    ) %>%
    dplyr::select(-A, -B, -C, -D)
  
  subj_list[[i]] <- df_fill
}

rm(i, df, df_B, df_D, df_fill)
  
Ludvig_2014_Exp1 <- bind_rows(subj_list)

summary(Ludvig_2014_Exp1)
```


# Rda
```{r}
usethis::use_data(Ludvig_2014_Exp1, overwrite = TRUE)
```

