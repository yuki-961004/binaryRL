---
title: "Untitled"
author: "yuki"
date: "2025-03-19"
output: html_document
---
```{r}
library(binaryRL)
```

```{r}
head(binaryRL::Mason_2024_Exp2)
```

```{r}
test <-binaryRL::run_m(
  data = binaryRL::Mason_2024_Exp2,                    
  id = 1,                       
  eta = c(0.3),  
  tau = c(0.1),
  n_params = 2,            
  n_trials = 360,            
  mode = "fit"
)

test <- test[[1]] %>%
  dplyr::filter(Frame == "Gain")
```


```{r}
model <- function(params){

  # build a RL model
  res <- binaryRL::run_m(
    data = data,                    # your data
    id = id,                        # Subject ID
    eta = c(params[1], params[2]),  # free parameters (RSTD)
    n_params = n_params,            # the number of free parameters
    n_trials = n_trials,            # the number of total trials
    mode = mode
  )

  # pass the result to the fit_env
  assign(x = "binaryRL.res", value = res, envir = binaryRL.env)
  
  switch(mode, "fit" = -res$ll, "simulate" = res, "review" = res)
}
```

```{r}
binaryRL.res <- binaryRL::optimize_para(
  data = binaryRL::Mason_2024_Exp2,
  id = 10,
  obj_func = binaryRL::RSTD,
  n_params = 3,
  n_trials = 288,
  lower = c(0, 0, 0),
  upper = c(1, 1, 1),
  iteration = 10,
  seed = 123,
  #algorithm = "L-BFGS-B"  # Gradient-Based (stats::optim)
  #algorithm = "GenSA"      # Simulated Annealing (GenSA::GenSA)
  #algorithm = "GA"        # Genetic Algorithm (GA::ga)
  #algorithm = "DEoptim"   # Differential Evolution (DEoptim::DEoptim)
  #algorithm = "PSO"       # Particle Swarm Optimization (pso::psoptim)
  algorithm = "Bayesian"  # Bayesian Optimization (mlrMBO::mbo)
  #algorithm = "CMA-ES"    # Covariance Matrix Adapting (`cmaes::cma_es`)
)
```


# Model Comparison
```{r include=FALSE}
comparison <- binaryRL::fit_p(
  data = read.csv("../DATA/df_pilot.csv"),
  n_trials = 288,
  id = c(1:40),
  fit_model = list(binaryRL::TD, binaryRL::RSTD, binaryRL::Utility),
  model_name = c("TD", "RSTD", "Utility"),
  lower = list(c(0, 0), c(0, 0, 0), c(0, 0, 0)),
  upper = list(c(1, 10), c(1, 1, 10), c(1, 1, 10)),
  iteration = 50,
  seed = 123,
  algorithm = "L-BFGS-B"  # Gradient-Based (stats::optim)
  #algorithm = "GenSA"     # Simulated Annealing (GenSA::GenSA)
  #algorithm = "GA"        # Genetic Algorithm (GA::ga)
  #algorithm = "DEoptim"   # Differential Evolution (DEoptim::DEoptim)
  #algorithm = "PSO"       # Particle Swarm Optimization (pso::psoptim)
  #algorithm = "Bayesian"  # Bayesian Optimization (mlrMBO::mbo)
  #algorithm = "CMA-ES"    # Covariance Matrix Adapting (`cmaes::cma_es`)
)

result <- dplyr::bind_rows(comparison)

write.csv(result, "../OUTPUT/result_comparison.csv", row.names = FALSE)
```

```{r}
data <- read.csv("../OUTPUT/result_comparison.csv") %>%
  dplyr::select(-dplyr::starts_with("param_")) %>%
  tidyr::pivot_longer(
    cols = c(ACC, LogL, AIC, BIC),
    names_to = "metric", 
    values_to = "value"
  ) %>%
  dplyr::group_by(Subject, metric) %>%
  dplyr::mutate(
    value_norm = (value - min(value)) / (max(value) - min(value) + 1e-10), 
    fit_model = factor(
      fit_model,
      levels = c("TD", "RSTD", "Utility")
    ),
    metric = factor(
      metric, 
      levels = c('ACC', 'LogL', 'AIC', 'BIC'),
      labels = c('ACC', '-LogL', 'AIC', 'BIC')
    )
  ) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(Subject, fit_model)

plot <- ggplot2::ggplot(data, aes(x = metric, y = value_norm, fill = fit_model)) +
  ggplot2::geom_bar(stat = "summary", fun = "mean", position = "dodge") +
  ggplot2::geom_errorbar(
    stat = "summary", fun.data = "mean_se",
    position = position_dodge(width = 0.9), width = 0.2
  ) +
  ggplot2::labs(x = "Normalized Metric", y = "", fill = "Model") +
  ggplot2::scale_fill_manual(values = c("#053562", "#55c186", "#f0de36")) +
  ggplot2::coord_cartesian(ylim = c(0, 1)) +
  ggplot2::scale_y_continuous(labels = scales::percent) +
  papaja::theme_apa() +
  ggplot2::theme(
    legend.title = element_blank(),
    text = element_text(
      family = "serif", 
      face = "bold",
      size = 25
    ),
    axis.text = element_text(
      color = "black",
      family = "serif", 
      face = "bold",
      size = 20
    )
  )  
  
ggplot2::ggsave(
  plot = plot,
  filename = "../FIGURE/model_comparison.png", 
  width = 8, height = 6
)
```

# Recovery
```{r}
list_simulated <- binaryRL::simulate_list(
  data = binaryRL::Mason_2024_Exp2,
  id = 1,
  obj_func = binaryRL::RSTD,
  n_params = 3, 
  n_trials = 360,
  lower = c(0, 0, 1),
  upper = c(1, 1, 10),
  seed = 123,
  iteration = 10
)
```

```{r include=FALSE}
df_recovery <- binaryRL::recovery_data(
  list = list_simulated,
  id = 1,
  fit_model = binaryRL::RSTD,
  model_name = "RSTD",
  n_params = 3,
  n_trials = 360,
  lower = c(0, 0, 1),
  upper = c(1, 1, 2),
  iteration = 50,
  algorithm = "Bayesian"
)
```

```{r include=FALSE}
recovery <- binaryRL::rcv_d(
  data = binaryRL::Mason_2024_Exp2,
  id = 1,
  n_trials = 360,
  model_names = c("TD", "RSTD", "Utility"),
  simulate_models = list(binaryRL::TD, binaryRL::RSTD, binaryRL::Utility),
  simulate_lower = list(c(0, 1), c(0, 0, 1), c(0, 0, 1)),
  simulate_upper = list(c(1, 10), c(1, 1, 10), c(1, 1, 10)),
  fit_models = list(binaryRL::TD, binaryRL::RSTD, binaryRL::Utility),
  fit_lower = list(c(0, 1), c(0, 0, 1), c(0, 0, 1)),
  fit_upper = list(c(1, 2), c(1, 1, 2), c(1, 1, 2)),
  initial_params = NA,
  initial_size = 50,
  seed = 123,
  iteration_s = 50,
  iteration_f = 50,
  algorithm = "Bayesian"
)

result <- dplyr::bind_rows(recovery) %>%
  dplyr::select(simulate_model, fit_model, iteration, everything())

write.csv(result, file = "../OUTPUT/result_recovery.csv", row.names = FALSE)
```

## Parameter Recovery
```{r function}
plot_param_rcv <- function(
  data = read.csv("../OUTPUT/result_recovery.csv"),
  model,
  param_index,
  param_name,
  filename,
  softmax
){
  switch(
    softmax, 
    "TRUE" = {
      data <- data %>%
        dplyr::filter(simulate_model == fit_model & simulate_model == model) %>%
          dplyr::mutate(
            log_input = log10(.data[[paste0("input_param_", param_index)]]),
            log_output = log10(.data[[paste0("output_param_", param_index)]])
          )
      set.seed(123)
      # Generate exponential data for x
      x <- rexp(100, rate = -log(1e-5) / 1)
      
      # Add smaller exponential noise to create y
      norm <- data.frame(
        x = log10(x),
        y = log10(x + rexp(100, rate = 10))  # Higher rate results in smaller fluctuations
      )
      
      plot <- ggplot2::ggplot(data, aes(x = log_input, y = log_output)) +
        ggplot2::geom_smooth(
          data = norm,
          mapping = aes(x = x, y = y),
          method = "lm", color = "#55c186", se = FALSE
        ) +
        ggplot2::geom_point(
          data = norm,
          mapping = aes(x = x, y = y),
          color = "#55c186",  
          alpha = 0.5, shape = 1
        ) +
        ggplot2::geom_point(color = "#053562") +  # 绘制散点
        ggplot2::scale_y_continuous(
          limits = c(-3, 1.1), expand = c(0, 0),
          labels = function(x) parse(text = paste0("10^", x))
        ) +
        ggplot2::scale_x_continuous(
          limits = c(-3, 0.3), expand = c(0, 0),
          labels = function(x) parse(text = paste0("10^", x))
        ) +
        ggplot2::labs(
          x = paste("simulated", param_name),
          y = paste("fit", param_name)
        ) +
        papaja::theme_apa() +
        ggplot2::theme(
          text = element_text(
            family = "serif", 
            face = "bold",
            size = 15
          ),
          plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
        )
      
      rm(x, norm)
      
      ggplot2::ggsave(
        plot = plot,
        filename = filename, 
        width = 4, height = 3
      )
    }, 
    "FALSE" = {
      data <- data %>%
        dplyr::filter(simulate_model == fit_model & simulate_model == model)
      
      set.seed(123)
      
      x <- runif(100, 0, 1)
      norm <- data.frame(
        x = x,  
        y = x + rnorm(100, 0, 0.1)  
      )
      
      plot <- ggplot2::ggplot(
        data, 
        mapping = aes(
          x = .data[[paste0("input_param_", param_index)]],
          y = .data[[paste0("output_param_", param_index)]]
        )) +
        ggplot2::geom_abline(intercept = 0, slope = 1, color = "#55c186") +  
        ggplot2::geom_point(
          data = norm,
          mapping = aes(x = x, y = y),
          color = "#55c186",  
          alpha = 0.5, shape = 1
        ) +
        ggplot2::geom_point(color = "#053562") +  # 绘制散点
        ggplot2::scale_y_continuous(limits = c(0, 1.1), expand = c(0, 0)) +
        ggplot2::scale_x_continuous(limits = c(0, 1.1), expand = c(0, 0)) +
        ggplot2::labs(
          x = paste("simulated", param_name),
          y = paste("fit", param_name)
        ) +
        papaja::theme_apa() +
        ggplot2::theme(
          text = element_text(
            family = "serif", 
            face = "bold",
            size = 15
          ),
          axis.text = element_text(
            color = "black",
            family = "serif", 
            face = "plain",
            size = 10
          ),
          plot.margin = margin(t = 10, r = 10, b = 10, l = 10)
        )
      
      ggplot2::ggsave(
        plot = plot,
        filename = filename, 
        width = 4, height = 3
      ) 
    },
  )
}


```

### eta
```{r warning=FALSE}
plot_param_rcv(
  data = read.csv("../OUTPUT/result_recovery.csv"),
  model = "TD",
  param_index = 1,
  param_name = "η",
  filename = "../FIGURE/1_TD_eta.png",
  softmax = "FALSE"
)

plot_param_rcv(
  data = read.csv("../OUTPUT/result_recovery.csv"),
  model = "RSTD",
  param_index = 1,
  param_name = "η-",
  filename = "../FIGURE/2_RSTD_eta1.png",
  softmax = "FALSE"
)

plot_param_rcv(
  data = read.csv("../OUTPUT/result_recovery.csv"),
  model = "RSTD",
  param_index = 2,
  param_name = "η+",
  filename = "../FIGURE/2_RSTD_eta2.png",
  softmax = "FALSE"
)

plot_param_rcv(
  data = read.csv("../OUTPUT/result_recovery.csv"),
  model = "Utility",
  param_index = 1,
  param_name = "η",
  filename = "../FIGURE/3_Utility_eta.png",
  softmax = "FALSE"
)
```

```{r}
data <- read.csv("../OUTPUT/result_recovery.csv") %>%
  dplyr::filter(simulate_model == fit_model & simulate_model == "TD") 
cor(data$input_param_1, data$output_param_1)

data <- read.csv("../OUTPUT/result_recovery.csv") %>%
  dplyr::filter(simulate_model == fit_model & simulate_model == "RSTD") 
cor(data$input_param_1, data$output_param_1)

data <- read.csv("../OUTPUT/result_recovery.csv") %>%
  dplyr::filter(simulate_model == fit_model & simulate_model == "RSTD") 
cor(data$input_param_2, data$output_param_2)

data <- read.csv("../OUTPUT/result_recovery.csv") %>%
  dplyr::filter(simulate_model == fit_model & simulate_model == "Utility") 
cor(data$input_param_1, data$output_param_1)
```

### gamma
```{r}
plot_param_rcv(
  data = read.csv("../OUTPUT/result_recovery.csv"),
  model = "Utility",
  param_index = 2,
  param_name = "γ",
  filename = "../FIGURE/3_Utility_gamma.png",
  softmax = "FALSE"
)
```

```{r}
data <- read.csv("../OUTPUT/result_recovery.csv") %>%
  dplyr::filter(simulate_model == fit_model & simulate_model == "Utility") 
cor(data$input_param_2, data$output_param_2)
```

### tau
```{r warning=FALSE}
plot_param_rcv(
  data = read.csv("../OUTPUT/result_recovery.csv"),
  model = "TD",
  param_index = 2,
  param_name = "τ",
  filename = "../FIGURE/1_TD_tau.png",
  softmax = "TRUE"
)

plot_param_rcv(
  data = read.csv("../OUTPUT/result_recovery.csv"),
  model = "RSTD",
  param_index = 3,
  param_name = "τ",
  filename = "../FIGURE/2_RSTD_tau.png",
  softmax = "TRUE"
)

plot_param_rcv(
  data = read.csv("../OUTPUT/result_recovery.csv"),
  model = "Utility",
  param_index = 3,
  param_name = "τ",
  filename = "../FIGURE/3_Utility_tau.png",
  softmax = "TRUE"
)
```

```{r}
data <- read.csv("../OUTPUT/result_recovery.csv") %>%
  dplyr::filter(simulate_model == fit_model & simulate_model == "TD") 
cor(data$input_param_2, data$output_param_2)

data <- read.csv("../OUTPUT/result_recovery.csv") %>%
  dplyr::filter(simulate_model == fit_model & simulate_model == "RSTD") 
cor(data$input_param_3, data$output_param_3)

data <- read.csv("../OUTPUT/result_recovery.csv") %>%
  dplyr::filter(simulate_model == fit_model & simulate_model == "Utility") 
cor(data$input_param_3, data$output_param_3)
```

## Model Recovery
### Confusion Matrix
```{r}
data <- read.csv("../OUTPUT/result_recovery.csv") %>%
  dplyr::select(simulate_model, fit_model, iteration, BIC) %>%
  tidyr::pivot_wider(names_from = "fit_model", values_from = "BIC") %>%
  dplyr::mutate(
    TD_score = ifelse(TD == pmin(TD, RSTD, Utility), 1, 0),
    RSTD_score = ifelse(RSTD == pmin(TD, RSTD, Utility), 1, 0),
    Utility_score = ifelse(Utility == pmin(TD, RSTD, Utility), 1, 0)
  ) %>% 
  dplyr::select(simulate_model, TD_score, RSTD_score, Utility_score) %>%
  dplyr::group_by(simulate_model) %>%
  dplyr::summarise(
    TD = round(mean(TD_score), 2),
    RSTD = round(mean(RSTD_score), 2),
    Utility = round(mean(Utility_score), 2),
  ) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(factor(simulate_model, levels = c("TD", "RSTD", "Utility"))) %>%
  tidyr::pivot_longer(
    cols = -simulate_model, 
    names_to = "fit_model", 
    values_to = "value"
  ) %>%
  dplyr::mutate(
    simulate = factor(simulate_model, levels = c("TD", "RSTD", "Utility")),
    fit = factor(fit_model, levels = c("TD", "RSTD", "Utility")),
  ) 

plot <- ggplot2::ggplot(data, aes(x = simulate, y = fit, fill = value)) +
  ggplot2::geom_tile() +
  ggplot2::scale_fill_gradient2(
    low = "#003161", mid = "#55c186", high = "#f0de36",
    limits = c(0, 1), 
    midpoint = 0.4       
  ) + 
  ggplot2::labs(
    title = "Confusion Matrix: P(fit model | simulated model)",
    x = "simulate model", 
    y = "fit model"
  ) + 
  ggplot2::geom_text(aes(label = value), size = 10, color = "white") +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = "none",
    panel.background = ggplot2::element_rect(fill = "white", color = NA),
    plot.background = ggplot2::element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(
      family = "serif", face = "bold",
      size = 25, hjust = 1.5, margin = margin(b = 20)
    ),
    axis.title.y = element_text(
      family = "serif", face = "bold",
      size = 25, margin = margin(r = 20)
    ),
    axis.title.x = element_text(
      family = "serif", face = "bold",
      size = 25, margin = margin(t = 20)
    ),
    axis.text = element_text(
      color = "black", family = "serif",  face = "bold",
      size = 20
    )
  )

ggplot2::ggsave(
  plot = plot,
  filename = "../FIGURE/matrix_confusion.png", 
  width = 8, height = 6
)
```

### Inversion Matrix
```{r}
data <- read.csv("../OUTPUT/result_recovery.csv") %>%
  dplyr::select(simulate_model, fit_model, iteration, BIC) %>%
  tidyr::pivot_wider(names_from = "fit_model", values_from = "BIC") %>%
  dplyr::mutate(
    TD_score = ifelse(TD == pmin(TD, RSTD, Utility), 1, 0),
    RSTD_score = ifelse(RSTD == pmin(TD, RSTD, Utility), 1, 0),
    Utility_score = ifelse(Utility == pmin(TD, RSTD, Utility), 1, 0)
  ) %>% 
  dplyr::select(simulate_model, TD_score, RSTD_score, Utility_score) %>%
  dplyr::group_by(simulate_model) %>%
  dplyr::summarise(
    TD = round(mean(TD_score), 2),
    RSTD = round(mean(RSTD_score), 2),
    Utility = round(mean(Utility_score), 2),
  ) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(factor(simulate_model, levels = c("TD", "RSTD", "Utility"))) %>%
  tidyr::pivot_longer(
    cols = -simulate_model, 
    names_to = "fit_model", 
    values_to = "value"
  ) %>%
  dplyr::mutate(
    simulate = factor(simulate_model, levels = c("TD", "RSTD", "Utility")),
    fit = factor(fit_model, levels = c("TD", "RSTD", "Utility")),
  ) %>%
  dplyr::group_by(fit_model) %>%
  dplyr::mutate(value = round(value / sum(value), 2)) %>%
  dplyr::ungroup()

plot <- ggplot2::ggplot(data, aes(x = simulate, y = fit, fill = value)) +
  ggplot2::geom_tile() +
  ggplot2::scale_fill_gradient2(
    low = "#003161", mid = "#55c186", high = "#f0de36",
    limits = c(0, 1), 
    midpoint = 0.4       
  ) + 
  ggplot2::labs(
    title = "Inversion Matrix: P(simulated model | fit model)",
    x = "simulate model", 
    y = "fit model"
  ) + 
  ggplot2::geom_text(aes(label = value), size = 10, color = "white") +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = "none",
    panel.background = ggplot2::element_rect(fill = "white", color = NA),
    plot.background = ggplot2::element_rect(fill = "white", color = NA),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(
      family = "serif", face = "bold",
      size = 25, hjust = 1.5, margin = margin(b = 20)
    ),
    axis.title.y = element_text(
      family = "serif", face = "bold",
      size = 25, margin = margin(r = 20)
    ),
    axis.title.x = element_text(
      family = "serif", face = "bold",
      size = 25, margin = margin(t = 20)
    ),
    axis.text = element_text(
      color = "black", family = "serif",  face = "bold",
      size = 20
    )
  )

ggplot2::ggsave(
  plot = plot,
  filename = "../FIGURE/matrix_inversion.png", 
  width = 8, height = 6
)
```

################################################################################

```{r}
ratio_plot <- function(df, filename) {
  summarise <- df %>%
    dplyr::group_by(Block, Frame) %>%
    dplyr::summarise(
      Rate_Mean = mean(Rate),
      Rate_SD = sd(Rate)
      / sqrt(n_distinct(Subject) - 1)
    ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(
      LLCI = Rate_Mean - Rate_SD,
      ULCI = Rate_Mean + Rate_SD,
    )

  p1 <- ggplot2::ggplot(
      data = df %>% dplyr::filter(Frame == "Gain"),
      mapping = aes(x = Block, y = Rate)
    ) +
    ggplot2::geom_point(mapping = aes(color = Subject), alpha = 0.2) +
    ggplot2::geom_line(mapping = aes(color = Subject), alpha = 0.2) +
    ggplot2::geom_errorbar(
      data = summarise %>% dplyr::filter(Frame == "Gain"),
      mapping = aes(x = Block, y = Rate_Mean, ymin = LLCI, ymax = ULCI), 
      size = 1, width = 0.3, color = "#FF6500"
    ) +
    ggplot2::geom_point(
      data = summarise %>% dplyr::filter(Frame == "Gain"),
      mapping = aes(x = Block, y = Rate_Mean), 
      size = 7, shape = 17, color = "#FF6500", 
    ) +
    ggplot2::scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6)) +
    ggplot2::scale_y_continuous(
      limits = c(-0.05, 1.05),
      breaks = c(0, 0.25, 0.5, 0.75, 1), 
      labels = c("0%", "25%", "50%", "75%", "100%")
    ) +
    ggplot2::labs(
      x = "Blcok", y = "The Ratio of Choosing Risky Door", title = "Gain Frame"
    ) +
    papaja::theme_apa() +
    ggplot2::theme(
      legend.position = "none"
    )
  
  p2 <- ggplot2::ggplot(
      data = df %>% dplyr::filter(Frame == "Loss"),
      mapping = aes(x = Block, y = Rate)
    ) +
    ggplot2::geom_point(mapping = aes(color = Subject), alpha = 0.2) +
    ggplot2::geom_line(mapping = aes(color = Subject), alpha = 0.2) +
    ggplot2::geom_errorbar(
      data = summarise %>% dplyr::filter(Frame == "Loss"),
      mapping = aes(x = Block, y = Rate_Mean, ymin = LLCI, ymax = ULCI), 
      size = 1, width = 0.3, color = "#86B6F6"
    ) +
    ggplot2::geom_point(
      data = summarise %>% dplyr::filter(Frame == "Loss"),
      mapping = aes(x = Block, y = Rate_Mean), 
      size = 7, shape = 17, color = "#86B6F6", 
    ) +
    ggplot2::scale_x_continuous(breaks = c(1, 2, 3, 4, 5, 6)) +
    ggplot2::scale_y_continuous(
      limits = c(-0.05, 1.05),
      breaks = c(0, 0.25, 0.5, 0.75, 1), 
      labels = c("0%", "25%", "50%", "75%", "100%")
    ) +
    ggplot2::labs(
      x = "Blcok", y = "The Ratio of Choosing Risky Door", title = "Loss Frame"
    ) +
    papaja::theme_apa() +
    ggplot2::theme(
      legend.position = "none"
    )
  
  save <- p1 + p2 + plot_layout(nrow = 1, guides = 'collect')
  
  ggplot2::ggsave(
    plot = save,
    filename = filename,
    width = 15,
    height = 5,
  )
}

```

```{r}
id <- c(1:40)
list <- list()
```

```{r}
data <- binaryRL::Ludvig_2014_Exp1 %>%
  dplyr::filter(Frame %in% c("Gain","Loss")) %>%
  dplyr::select(Subject, Block, Trial, Frame, Sub_Choose) %>%
  dplyr::mutate(
    Subject = factor(Subject),
    Block = as.numeric(Block),
    Sub_Choose = case_when(
      Sub_Choose %in% c("A", "C") ~ 0,
      Sub_Choose %in% c("B", "D") ~ 1,
    ),
  ) %>%
  dplyr::group_by(Subject, Block, Frame) %>%
  dplyr::summarise(Rate = mean(Sub_Choose)) %>%
  #dplyr::mutate(Time = row_number()) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(Subject, Frame, Block)

library(patchwork)

ratio_plot(df = data, filename = "../FIGURE/0_raw.png")
```

# Review
```{r}
list <- list()
```

## TD
```{r}
result <- read.csv("../OUTPUT/result_comparison.csv")  %>%
  dplyr::filter(fit_model == "TD")

res <- list()

for (i in 1:length(id)) {
  
  params <- na.omit(unlist(result[i, grep("param_", names(result))]))
  
  binaryRL.env <- new.env()
  binaryRL.env$data <- binaryRL::Ludvig_2014_Exp1
  binaryRL.env$id <- id[i]
  binaryRL.env$n_params <- length(params)
  binaryRL.env$n_trials <- 288
  binaryRL.env$mode <- "review"
  
  
  obj_func <- binaryRL::TD
  
  environment(obj_func) <- binaryRL.env
  res[[i]] <- obj_func(params = params)[[1]]
}

rm(i, params, obj_func, binaryRL.env)

list[[1]] <- dplyr::bind_rows(res)
```

```{r}
data <- list[[1]] %>%
  dplyr::filter(Frame %in% c("Gain","Loss")) %>%
  dplyr::select(Subject, Block, Trial, Frame, Rob_Choose) %>%
  dplyr::mutate(
    Subject = factor(Subject),
    Block = as.numeric(Block),
    Rob_Choose = case_when(
      Rob_Choose %in% c("A", "C") ~ 0,
      Rob_Choose %in% c("B", "D") ~ 1,
    ),
  ) %>%
  dplyr::group_by(Subject, Block, Frame) %>%
  dplyr::summarise(Rate = mean(Rob_Choose)) %>%
  #dplyr::mutate(Time = row_number()) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(Subject, Frame, Block)

ratio_plot(df = data, filename = "../FIGURE/1_TD.png")
```

## RSTD
```{r}
result <- read.csv("../OUTPUT/result_comparison.csv")  %>%
  dplyr::filter(fit_model == "RSTD")

res <- list()

for (i in 1:length(id)) {
  
  params <- na.omit(unlist(result[i, grep("param_", names(result))]))
  
  binaryRL.env <- new.env()
  binaryRL.env$data <- binaryRL::Ludvig_2014_Exp1
  binaryRL.env$id <- id[i]
  binaryRL.env$n_params <- length(params)
  binaryRL.env$n_trials <- 288
  binaryRL.env$mode <- "review"
  
  obj_func <- binaryRL::RSTD
  
  environment(obj_func) <- binaryRL.env
  res[[i]] <- obj_func(params = params)[[1]]
}

rm(i, params, obj_func, binaryRL.env)

list[[2]] <- dplyr::bind_rows(res)
```

```{r}
data <- list[[2]] %>%
  dplyr::filter(Frame %in% c("Gain","Loss")) %>%
  dplyr::select(Subject, Block, Trial, Frame, Rob_Choose) %>%
  dplyr::mutate(
    Subject = factor(Subject),
    Block = as.numeric(Block),
    Rob_Choose = case_when(
      Rob_Choose %in% c("A", "C") ~ 0,
      Rob_Choose %in% c("B", "D") ~ 1,
    ),
  ) %>%
  dplyr::group_by(Subject, Block, Frame) %>%
  dplyr::summarise(Rate = mean(Rob_Choose)) %>%
  #dplyr::mutate(Time = row_number()) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(Subject, Frame, Block)

library(patchwork)
ratio_plot(df = data, filename = "../FIGURE/2_RSTD.png")
```

## Utility
```{r}
result <- read.csv("../OUTPUT/result_comparison.csv")  %>%
  dplyr::filter(fit_model == "Utility")

res <- list()

for (i in 1:length(id)) {
  
  params <- na.omit(unlist(result[i, grep("param_", names(result))]))
  
  binaryRL.env <- new.env()
  binaryRL.env$data <- binaryRL::Ludvig_2014_Exp1
  binaryRL.env$id <- id[i]
  binaryRL.env$n_params <- length(params)
  binaryRL.env$n_trials <- 288
  binaryRL.env$mode <- "review"
  
  obj_func <- binaryRL::Utility
  
  environment(obj_func) <- binaryRL.env
  res[[i]] <- obj_func(params = params)[[1]]
}

rm(i, params, obj_func, binaryRL.env)

list[[3]] <- dplyr::bind_rows(res)
```

```{r}
data <- list[[3]] %>%
  dplyr::filter(Frame %in% c("Gain","Loss")) %>%
  dplyr::select(Subject, Block, Trial, Frame, Rob_Choose) %>%
  dplyr::mutate(
    Subject = factor(Subject),
    Block = as.numeric(Block),
    Rob_Choose = case_when(
      Rob_Choose %in% c("A", "C") ~ 0,
      Rob_Choose %in% c("B", "D") ~ 1,
    ),
  ) %>%
  dplyr::group_by(Subject, Block, Frame) %>%
  dplyr::summarise(Rate = mean(Rob_Choose)) %>%
  #dplyr::mutate(Time = row_number()) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(Subject, Frame, Block)

library(patchwork)
ratio_plot(df = data, filename = "../FIGURE/3_Utility.png")
```